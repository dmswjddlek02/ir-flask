<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>범례 선택 + 차트 유형 통합</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .top-buttons {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    .top-buttons.hidden {
      display: none;
    }

    .top-buttons button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .side-wrapper {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      display: none;
      flex-direction: row;
      z-index: 999;
    }

    .side-wrapper.active {
      display: flex;
    }

    .button-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
      background-color: #e0e0e0;
      /* 높이 정렬 상단 고정 */
      align-items: flex-start;
      justify-content: flex-start;
      margin-top: 10px; /* 상단 버튼과 높이 일치 */
    }

    .button-panel button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .side-container {
      width: 20vw;
      height: 100%;
      background-color: #f9f9f9;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      padding: 20px;
      position: relative;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

  body {
    padding: 2rem;
    font-family: 'Noto Sans KR', sans-serif;
    background-color: #f9f9f9;
    color: #333;
  }
  h2 {
    margin-bottom: 1rem;
    font-size: 1.5rem;
    color: #222;
  }
  select, input[type="file"] {
    font-size: 1rem;
    padding: 0.4rem 0.6rem;
    margin-right: 1rem;
    margin-top: 0.5rem;
  }
  label {
    font-weight: bold;
    margin-right: 0.3rem;
  }
  canvas {
    background-color: white;
    border: 1px solid #ddd;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-top: 2rem;
  }
</style>

</head>



<body style="padding:2rem; font-family:sans-serif;">
  <h2>📊 차트 만들기 (범례 선택 + 차트 유형)</h2>
  <input type="file" id="excel-file" accept=".xlsx,.xls" />

  <div style="margin-top: 1rem;">
    <label>X축 컬럼:</label>
    <select id="x-col"></select>

    <label style="margin-left:1rem;">Y값 컬럼:</label>
    <select id="y-col"></select>

    <label style="margin-left:1rem;">범례 컬럼:</label>
    <select id="legend-col">
      <option value="">선택 안함</option> <!-- ✅ 디폴트 -->
    </select>

    <label style="margin-left:1rem;">차트 유형:</label>
    <select id="chart-type">
      <option value="bar">막대 그래프</option>
      <option value="stacked-bar">스택형 막대</option>
      <option value="line">선 그래프</option>

    </select>
  </div>

  <canvas id="myChart" width="700" height="400" style="margin-top: 2rem;"></canvas>

  <script>
    const topButtons = document.getElementById('topButtons');
    const container1 = document.getElementById('container1');
    const container2 = document.getElementById('container2');

    function openContainer(id) {
      topButtons.classList.add('hidden');
      container1.classList.remove('active');
      container2.classList.remove('active');
      document.getElementById(id).classList.add('active');
    }

    function closeContainers() {
      container1.classList.remove('active');
      container2.classList.remove('active');
      topButtons.classList.remove('hidden');
    }

    const fileInput = document.getElementById("excel-file");
    const xSelect = document.getElementById("x-col");
    const ySelect = document.getElementById("y-col");
    const legendSelect = document.getElementById("legend-col");
    const chartTypeSelect = document.getElementById("chart-type");
    const chartCanvas = document.getElementById("myChart");
    let jsonData = [];
    let myChart;

    function drawChart() {
      if (!jsonData.length) return;

      const xCol = xSelect.value;
      const yCol = ySelect.value;
      const legendCol = legendSelect.value;
      const chartType = chartTypeSelect.value;
      const isStacked = chartType === "stacked-bar";
      const isLegendUsed = legendCol !== "";

      const xSet = new Set();
      const grouped = {};
      const colors = ["#4dc9f6", "#f67019", "#f53794", "#537bc4", "#acc236", "#166a8f", "#ff6384"];

      if (isLegendUsed) {
        const legendSet = new Set();

        // ✅ 범례 기준 그룹핑
        jsonData.forEach(row => {
          const x = row[xCol];
          const legend = row[legendCol];
          const y = Number(row[yCol]) || 0;

          xSet.add(x);
          legendSet.add(legend);

          if (!grouped[legend]) grouped[legend] = {};
          grouped[legend][x] = (grouped[legend][x] || 0) + y;
        });

        const xLabels = Array.from(xSet);
        const legends = Array.from(legendSet);

        const datasets = legends.map((legend, i) => {
        const dataset = {
        label: legend,
        data: xLabels.map(x => grouped[legend][x] || 0),
        backgroundColor: colors[i % colors.length],
        borderColor: colors[i % colors.length],
        fill: chartType !== 'line'
    };
    if (isStacked) {
        dataset.stack = 'stack1';
    }
  return dataset;
});


        renderChart(chartType === 'stacked-bar' ? 'bar' : chartType, xLabels, datasets, isStacked);

      } else {
        // ✅ 범례 없을 때 (단일 컬럼 기준)
        jsonData.forEach(row => {
          const x = row[xCol];
          const y = Number(row[yCol]) || 0;
          xSet.add(x);
          grouped[x] = (grouped[x] || 0) + y;
        });

        const xLabels = Array.from(xSet);
        const dataset = [{
          label: yCol,
          data: xLabels.map(x => grouped[x]),
          backgroundColor: 'skyblue',
          borderColor: 'skyblue',
          fill: chartType !== 'line'
        }];

        renderChart(chartType === 'stacked-bar' ? 'bar' : chartType, xLabels, dataset, false);
      }
    }

    function renderChart(type, labels, datasets, stacked) {
      if (myChart) myChart.destroy();
      const ctx = chartCanvas.getContext("2d");
      myChart = new Chart(ctx, {
        type,
        data: { labels, datasets },
        options: {
          responsive: false,
          plugins: {
            title: {
              display: true,
              text: "차트 미리보기"
            },
            legend: {
              display: true,
              position: 'top'
            }
          },
        scales: {
  x: {
    stacked: stacked,
    offset: true,  // ✅ 중심 정렬
    categoryPercentage: stacked ? 0.8 : 0.6,
    barPercentage: stacked ? 1.0 : 0.9,
    ticks: {
      align: 'center'
    }
  },
  y: {
    stacked: stacked,
    beginAtZero: true
  }
}


        }
      });
    }

    // ✅ 엑셀 업로드
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        jsonData = XLSX.utils.sheet_to_json(worksheet);

        const columns = Object.keys(jsonData[0]);

        [xSelect, ySelect].forEach(select => {
          select.innerHTML = "";
          columns.forEach(col => select.appendChild(new Option(col, col)));
        });

        // 범례: "선택 안함" 유지한 채로 컬럼만 추가
        legendSelect.innerHTML = '<option value="">선택 안함</option>';
        columns.forEach(col => legendSelect.appendChild(new Option(col, col)));

        drawChart();
      };

      reader.readAsArrayBuffer(file);
    });

    // ✅ 실시간 반영
    [xSelect, ySelect, legendSelect, chartTypeSelect].forEach(sel => {
      sel.addEventListener("change", drawChart);
    });
  </script>
</body>
</html>
